# ============================================================
# Esparagus-Audio-Brick - Media Player Configuration
# ============================================================
# ESP32 audio board with TAS5825M DAC (I2C+I2S) with built-in DSP
# Configured with Sendspin for synchronized multi-room audio
# Board-specific pinouts defined in substitutions
# Functional blocks imported from /packages
# ============================================================

substitutions:
  name: esphome-web-2cbffc
  friendly_name: Esparagus-Audio-Brick
  task_stack_in_psram: "false"

  # ===== Board-Specific Pinouts =====
  # I2S audio pins
  i2s_lrclk_pin: GPIO15
  i2s_bclk_pin: GPIO14
  i2s_dout_pin: GPIO16

  # TAS5825M
  tas58xx_variant: TAS5825M
  tas58xx_enable_pin: GPIO17
  i2c_sda_pin: GPIO8
  i2c_scl_pin: GPIO9

  # RGB LED
  rgb_led_pin: GPIO21

  # SPI pins (for display)
  spi_clk_pin: GPIO12
  spi_mosi_pin: GPIO11
  spi_miso_pin: GPIO13
  
  # Display control pins
  display_cs_pin: GPIO47
  display_dc_pin: GPIO38
  display_reset_pin: GPIO48

  # Ethernet pins (if using ethernet instead of wifi)
  eth_cs_pin: GPIO10
  eth_interrupt_pin: GPIO6
  eth_reset_pin: GPIO5

esphome:
  name: ${name}
  friendly_name: ${friendly_name}
  min_version: 2025.12.2
  name_add_mac_suffix: false
  platformio_options:
    board_build.flash_mode: dio
  # Importnant! Play sound on boot required for DAC to capture clock signal and enable DSP configuration
  # If any of the DSP configs are sent before clock signal, they are simply ignored. This applies to EQ and Mixer controls
  on_boot:
    priority: 220.0
    then:
      media_player.play_media:
        id: external_media_player
        media_url: file://startup_sync_sound

esp32:
  variant: ESP32S3
  flash_size: 8MB
  cpu_frequency: 240MHz
  framework:
    type: esp-idf
    version: recommended
    sdkconfig_options:
      CONFIG_ESP32S3_DATA_CACHE_64KB: "y"
      CONFIG_ESP32S3_DATA_CACHE_LINE_64B: "y"
      CONFIG_ESP32S3_INSTRUCTION_CACHE_32KB: "y"
      # Moves instructions and read only data from flash into PSRAM on boot.
      # Both enabled allows instructions to execute while a flash operation is in progress without needing to be placed in IRAM.
      # Considerably speeds up mWW at the cost of using more PSRAM.
      CONFIG_SPIRAM_RODATA: "y"
      CONFIG_SPIRAM_FETCH_INSTRUCTIONS: "y"
      CONFIG_BT_ALLOCATION_FROM_SPIRAM_FIRST: "y"
      CONFIG_BT_BLE_DYNAMIC_ENV_MEMORY: "y"
      CONFIG_MBEDTLS_EXTERNAL_MEM_ALLOC: "y"
      CONFIG_MBEDTLS_SSL_PROTO_TLS1_3: "y" 

logger:
  level: DEBUG

api:

ota:
  platform: esphome
  password: !secret esphome_ota_password

wifi:
  ssid: !secret esphome_wifi_ssid
  password: !secret esphome_wifi_password

psram:
  mode: octal
  speed: 80MHz
  ignore_not_found: false

network:
  enable_ipv6: true
  
http_request:

# ===== Packages =====
packages:
  esparagus_remote:
    url: https://github.com/sonocotta/esparagus-media-center
    ref: main
    files:
      # Option A: TAS58xx configured with ganged 15-band EQ
      - firmware/esphome/packages/tas58xx-dac.yaml
      # Option B: TAS58xx configured with individual 15-band EQ per channel
      # - firmware/esphome/packages/tas58xx-dac-biamp.yaml
      # Option C: TAS58xx configured with bi-amp mode, with filters applied to both channels (HF or LF)
      # - firmware/esphome/packages/tas58xx-dac-presets.yaml

      # Option A: no OLED connected
      - firmware/esphome/packages/sendspin-tas58xx.yaml
      # Option B: OLED displays clock when idling, and track/artist info when playing
      # - firmware/esphome/packages/sendspin-tas58xx-with-oled.yaml
      # - firmware/esphome/packages/oled-sendspin.yaml

      - firmware/esphome/packages/sendspin-audio-tas58xx.yaml
      - firmware/esphome/packages/light.yaml
      - firmware/esphome/packages/monitoring.yaml
      # Optional ethernet (replace wifi config if you use this)
      # - firmware/esphome/packages/ethernet-w5500.yaml

  # Debug/local development fallback:
  # tas58xx_dac: !include packages/tas58xx-dac.yaml
  # tas58xx_dac_biamp: !include packages/tas58xx-dac-biamp.yaml
  # tas58xx_dac_biamp: !include packages/tas58xx-dac-presets.yaml
  # audio: !include packages/sendspin-audio-tas58xx.yaml
  # sendspin: !include packages/sendspin-tas58xx.yaml
  # sendspin: !include packages/sendspin-tas58xx-with-oled.yaml
  # oled: !include packages/oled-sendspin.yaml
  # light: !include packages/light.yaml
  # ethernet: !include packages/ethernet-w5500.yaml
  # monitoring: !include packages/monitoring.yaml