# ============================================================
# Loud-Esparagus - Sendspin Configuration
# ============================================================
# ESP32 audio board with dual MAX98357A DAC, I2S output
# Configured with Sendspin for synchronized multi-room audio
# Board-specific pinouts defined in substitutions
# Functional blocks imported from /packages
# ============================================================

substitutions:
  name: esphome-web-d1d810
  friendly_name: Loud-Esparagus
  task_stack_in_psram: "false"

  # ===== Board-Specific Pinouts =====
  # I2S Audio (PCM5100 DAC)
  i2s_lrclk_pin: GPIO25
  i2s_bclk_pin: GPIO26
  i2s_dout_pin: GPIO22
  dac_enable_pin: GPIO13

  # RGB LED
  rgb_led_pin: GPIO33
  
  # IR Receiver
  ir_rx_pin: GPIO39

esphome:
  name: ${name}
  friendly_name: ${friendly_name}
  min_version: 2026.2.0
  platformio_options:
    board_build.flash_mode: dio

esp32:
  variant: esp32
  flash_size: 8MB
  cpu_frequency: 240MHz
  framework:
    type: esp-idf
    version: recommended
    advanced:
      minimum_chip_revision: "3.1" 
    sdkconfig_options:
      # Moves instructions and read only data from flash into PSRAM on boot.
      # Both enabled allows instructions to execute while a flash operation is in progress without needing to be placed in IRAM.
      # Considerably speeds up mWW at the cost of using more PSRAM.
      CONFIG_SPIRAM_RODATA: "y"
      CONFIG_SPIRAM_FETCH_INSTRUCTIONS: "y"
      CONFIG_BT_ALLOCATION_FROM_SPIRAM_FIRST: "y"
      CONFIG_BT_BLE_DYNAMIC_ENV_MEMORY: "y"
      CONFIG_MBEDTLS_EXTERNAL_MEM_ALLOC: "y"
      CONFIG_MBEDTLS_SSL_PROTO_TLS1_3: "y"

logger:
  level: DEBUG

api:

ota:
  platform: esphome
  password: !secret esphome_ota_password

wifi:
  ssid: !secret esphome_wifi_ssid
  password: !secret esphome_wifi_password

psram:
  speed: 80MHz

network:
  enable_ipv6: true

# ===== Packages =====
packages:
  esparagus_remote:
    url: https://github.com/sonocotta/esparagus-media-center
    ref: main
    files:
      - firmware/esphome/packages/sendspin-audio.yaml
      - firmware/esphome/packages/sendspin-with-dac-enable.yaml
      - firmware/esphome/packages/light.yaml
      - firmware/esphome/packages/ir-receiver.yaml
      - firmware/esphome/packages/monitoring.yaml

  # Debug/local development fallback:
  # audio: !include packages/sendspin-audio.yaml
  # sendspin: !include packages/sendspin-with-dac-enable.yaml
  # light: !include packages/light.yaml
  # ir_receiver: !include packages/ir-receiver.yaml
  # monitoring: !include packages/monitoring.yaml